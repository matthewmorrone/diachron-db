<html>
<head>
<title>Transition Graph | Diachron DB</title>
<meta charset='UTF-8'>
<link href='https://www.matthewmorrone.com/psi-fff.ico' rel='shortcut icon' type='image/x-icon'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-white.ico' id='psi-white'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-black.ico' id='psi-black'>
<script src='https://matthewmorrone.com/icon.js'></script>
<script src='https://matthewmorrone.com/jquery.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.22.1/cytoscape.min.js"></script>
<script src="https://unpkg.com/layout-base/layout-base.js"></script>
<script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-avsdf/cytoscape-avsdf.js"></script>
<script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.5.0/cytoscape-dagre.js"></script>
<script src="https://unpkg.com/klayjs@0.4.1/klay.js"></script>
<script src="https://cytoscape.org/cytoscape.js-klay/cytoscape-klay.js"></script>
<script src="https://unpkg.com/layout-base/layout-base.js"></script>
<script src="https://unpkg.com/cose-base/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-layout-utilities/cytoscape-layout-utilities.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-fcose/cytoscape-fcose.js"></script>
<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cose-bilkent/1.6.5/cytoscape-cose-bilkent.js"></script>
<script src="https://unpkg.com/webcola/WebCola/cola.js"></script>
<script src="https://cytoscape.org/cytoscape.js-cola/cytoscape-cola.js"></script>
<script src="https://unpkg.com/layout-base@1.0.2/layout-base.js"></script>
<script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
<script src="https://unpkg.com/cose-base@1.0.3/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-graphml/cytoscape-graphml.js"></script>
<script src="https://raw.githack.com/iVis-at-Bilkent/cytoscape.js-layvo/unstable/cytoscape-layvo.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-cise/cytoscape-cise.js"></script>
<script src="https://unpkg.com/weaverjs@1.2.0/dist/weaver.min.js"></script>
<script src="https://cytoscape.org/cytoscape.js-spread/cytoscape-spread.js"></script>
<script src="https://cytoscape.org/cytoscape.js-euler/cytoscape-euler.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-cosep/demo/forTestingCose/cytoscape-cosep-port.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-cosep/cytoscape-cosep.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js"></script>
<script src="https://cytoscape.org/cytoscape.js-popper/cytoscape-popper.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/2.5.4/tippy.all.js"></script>
<style>
@import 'https://cdnjs.cloudflare.com/ajax/libs/tippy.js/2.5.4/tippy.css';
</style>
<script src='js/utils.js'></script>
<script type="module">
let url = 'mysql.php';
function populateSelect(id, options) {
    let $select = $(`#${id}`)
    options.forEach(function(entry) {
        let [key, val] = entry;
        $select.append(`<option>${val}</option>`);
    });
}
async function $get(url, data) {
    let result = false;
    try {
        result = await $.get(url, data);
    }
    catch(e) {
        console.error(e);
    }
    return result;
}
async function $getJSON(url, data) {
    let result = false;
    try {
        result = await $.getJSON(url, data);
    }
    catch(e) {
        console.error(e);
    }
    return result;
}
function get() {
    let qs = document.location.search;
    qs = qs.split('+').join(' ');
    let params = {}, tokens, re = /[?&]?([^=]+)=([^&]*)/g;
    while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
    }
    return params;
}
async function loadTransitions() {
    let headers = {mode: 'list', table: 'transitions'};
    let transitions = await $getJSON(url, headers);
    transitions = transitions.map(transition => {
        return [transition.id, transition.transition];
    });
    populateSelect(`transitions`, transitions);
    let transition = get()?.transition.replace(",", " â†’ ");
    if (transition) $("#transitions").val(transition)
}
async function loadPairs(transition) {
    transition = transition || $("#transitions").val();
    let headers = {mode: 'graph', type: 'transition', data: {value: transition}};
    let data = await $getJSON(url, headers);
    return data;
}
function cytoscapeFunctionality(cy) {
    cy.on('click', 'node', async function() {
        let segment = this.id();
        $("#segments").val(segment).trigger("change");
    });
}
async function doStuff() {
    await loadTransitions();
    let transition = $("#transitions").val();
    let transitionData = await loadPairs(transition);
    let data = {
        container: document.getElementById('cy'),
        elements: transitionData,
        selectionType: 'single',
        wheelSensitivity: 0.2,
        layout: {
            name: $("#layout").val(),
            animate: true,
            nodeDimensionsIncludeLabels: true,
            fit: true,
            padding: 5,
        },
        style: [{
            selector: 'node',
            style: {
                'label': 'data(id)',
                "text-valign" : "center",
                "text-halign" : "center"
            }
        }, {
            selector: 'edge',
            style: {
                'label': 'data(environment)',
                "text-rotation": "autorotate",
                'width': 1,
                'target-arrow-shape': 'triangle',
                'curve-style': $("#edge").val(),
                'taxi-direction': 'vertical'
            }
        }],
    };
    let cy = cytoscape(data);





    cytoscapeFunctionality(cy)
    $("#transitions").change(async function() {
        transition = $("#transitions").val();
        transitionData = await loadPairs(transition);
        data.elements = transitionData;
        data.layout.name = $("#layout").val();
        cy = cytoscape(data);
        cytoscapeFunctionality(cy);
        // window.history.pushState("object or string", "Title", "transition-graph.html/"+transition);
    });
    $("#edge").change(function() {
        console.log($(this).val())
        cy.style().selector('edge').style({
            'curve-style': $(this).val()
        }).update();
    });
    $("#layout").change(function() {
        let layoutName = $(this).val();
        console.log(`layout: ${$("#layout").val()}`)
        if (layoutName === "avsdf") {
            let layout = cy.layout({
                name: layoutName,
                nodeDimensionsIncludeLabels: true,
                fit: true,
                padding: 20,
            });
            layout.run();  
            return;   
        }
        let layout = cy.layout({
            name: layoutName,
            avoidOverlap: true,
            animate: true,
            nodeDimensionsIncludeLabels: true,
            fit: true,
            padding: 20,
            avoidOverlap: true, // prevents node overlap, may overflow boundingBox if not enough space
            avoidOverlapPadding: 10, // extra spacing around nodes when avoidOverlap: true
        });
        layout.run();
    });
    $("#layout").val($("#layout").val()).trigger("change");
}
$(function() {
    doStuff();
});
</script>
<style>
*::-webkit-scrollbar { 
    display: none;
}
#cy {
    width: 100%;
    height: 100%;
    display: block;
    margin: auto;
}
</style>
</head>
<body>
<select id="transitions"></select>
<select id="edge">
    <option>bezier</option>
    <option>unbundled-bezier</option>
    <option>straight</option>
    <option>haystack</option>
    <option>segments</option>
    <option selected>taxi</option>
    <option>straight-triangle</option>
</select>
<select id="layout">
    <option>random</option>
    <optgroup label="Geometric">
        <option>grid</option>
        <option>circle</option>
        <option>concentric</option>
        <option>avsdf</option>
    </optgroup>
    <optgroup label="Hierarchical">
        <option selected>dagre</option>
        <option>breadthfirst</option>
        <option>klay</option>
    </optgroup>
    <optgroup label="Force-directed">
        <option>fcose</option>
        <option>cose-bilkent</option>
        <option>cose</option>
        <option>cosep</option>
        <option>cola</option>
        <option>euler</option>
        <option>spread</option>
    </optgroup>
</select>
<div id='cy'></div>
</body>
</html>