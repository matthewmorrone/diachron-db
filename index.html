<html>
<head>
<title>Diachron DB</title>
<meta charset='UTF-8'>
<link href='https://www.matthewmorrone.com/psi-fff.ico' rel='shortcut icon' type='image/x-icon'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-white.ico' id='psi-white'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-black.ico' id='psi-black'>
<style>
@charset 'UTF-8';
/* @import 'https://www.matthewmorrone.com/reset.css'; */
@import 'https://www.matthewmorrone.com/jquery.ui.css';
@import 'https://www.matthewmorrone.com/font-awesome.min.css';
@import 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css';
@import 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css';
@import 'https://unpkg.com/@yaireo/tagify/dist/tagify.css';
@import 'style.css';
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/@yaireo/tagify"></script>
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<script src='https://matthewmorrone.com/icon.js'></script>
<script src='https://matthewmorrone.com/prefixfree.js'></script>
<script src='https://matthewmorrone.com/jquery.js'></script>
<script src='https://matthewmorrone.com/jquery.ui.js'></script>
<script src='https://matthewmorrone.com/jquery.helpers.js'></script>
<script src='utils.js'></script>
<script>
let log = console.log.bind(console);

let url = `mysql.php`;

function jsonToDataList(options, id) {
    let result = `<input type=text name=${id} list=${id} />`;
    result += `<datalist id='${id}'>`;
    Object.keys(options).forEach((key, index) => {
        result += `<option>${options[key]}</option>`;
    });
    result += '</datalist>';
    return result;
}
function jsonToTable(data, id) {
    let result = ``;
    result += `<table class="table" id='${id}'>`;
    result += `<thead>`;
    result += `<tr>`;
    for(key in data[0]) {
        if(key === 'id') continue;
        result += `<th class='sort'>${key.replace('_', ' ').toTitleCase()}</th>`;
    }
    result += `<th></th>`;
    result += `</tr>`;
    result += `</thead>`;
    result += `<tbody>`;
    for(var i = 0; i < data.length; i++) {
        result += `<tr pair='${data[i]['id']}'>`;
        for(key in data[i]) {
            if(key === 'id') continue;
            result += `<td class=${key}>${data[i][key]}</td>`;
        }
        result += `<td><button class='ex' data-bs-id="${data[i]['id']}"></button></td>`;
        result += `</tr>`;
    }
    result += `</tbody>`;
    result += `</table>`;
    return result;
}
function submitPair() {
    let submit = {
        mode: 'insert',
        table: 'pair',
        data: {
            source_lang: $('[name=source_lang]').val(),
            source_phone: $('[name=source_phone]').val(),
            target_lang: $('[name=target_lang]').val(),
            target_phone: $('[name=target_phone]').val(),
        }
    };
    if(!submit.data.source_lang
    || !submit.data.source_phone
    || !submit.data.target_lang
    || !submit.data.target_phone
     ) {
        return;
    }

    console.log(submit)
    $.get(url, submit, function(data) {
        console.log(data);
        loadTable();
    })
}
function download(filename, text) {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);

    element.style.display = 'none';
    document.body.appendChild(element);

    element.click();

    document.body.removeChild(element);
}
async function exportData() {
    $.get(url, {mode: 'dump'}, function(data) {
        download("diachron.json", data)
    })
}
async function loadTable() {
    let p1 = function() {
        return $.getJSON(url, {mode: 'list', table: 'pairs'}, function(data) {
            if(data.includes('Fatal error')) return;
            $(`content`).html(`<div>${jsonToTable(data, 'pairs')}</div>`);
            $('table thead').append(`<tr>
                <th><span id='source_lang_span'></span></th>
                <th><span id='source_phone_span'></span></th>
                <th><span id='target_lang_span'></span></th>
                <th><span id='target_phone_span'></span></th>
                <th><button class='plus'></button></th>
            </tr>`);
        });
    }
    let p2 = function() {
        return $.getJSON(url, {mode: 'list', table: 'phones'}, function(data) {
            $('#source_phone_span').html(jsonToDataList(data, 'source_phone'));
            $('#target_phone_span').html(jsonToDataList(data, 'target_phone'));
        });
    }
    let p3 = function() {
        return $.getJSON(url, {mode: 'list', table: 'languages'}, function(data) {
            $('#source_lang_span').html(jsonToDataList(data, 'source_lang'));
            $('#target_lang_span').html(jsonToDataList(data, 'target_lang'));
        });
    }
    let p4 = function() {
        $('input').on('change keyup', function() {
            $('table tbody tr').show();
            $('table tbody tr').each(function() {
                $(this).find("td").slice(0, 4).each(function() {
                    let col = $(this).index();
                    let val = $("input").eq(col).val();
                    if (val === '') return;
                    let text = $(this).text();
                    if (val && text.includes(val)) {
                        $(this).parent().show();
                    }
                    else {
                        $(this).parent().hide();
                    }
                });
            });
        });

        $('.plus').click(() => {
            submitPair();
        })
        $(document).keyup((e) => {
            if(e.which === 13) {
                $('.plus').click();
            }
        });

        // let $confirmDelete = $('#confirmDelete');
        $('.ex').click(function(e) {
            let button = $(e).target();
            let id = button.getAttribute('data-bs-id');

            $.get(url, {mode: "remove", table: "pair", id: id}, function(data) {
                console.log(data);
                // $confirmDelete.modal('hide');
                loadTable();
            });
            /*
            let button = $(e).target();
            let id = button.getAttribute('data-bs-id');
            [source_lang, source_phone, target_lang, target_phone] = [
                $(`[pair=${id}]`).find('.source_lang').text(),
                $(`[pair=${id}]`).find('.source_phone').text(),
                $(`[pair=${id}]`).find('.target_lang').text(),
                $(`[pair=${id}]`).find('.target_phone').text()
            ];

            $('.modal-body').html(`${source_phone} → ${target_phone}<br>(${source_lang} → ${target_lang})`);

            $confirmDelete.modal('show');

            $("#confirm").click(function() {
                $.get(url, {mode: "remove", table: "pair", id: id}, function(data) {
                    console.log(data);
                    $confirmDelete.modal('hide');
                    loadTable();
                });
            }) 
            */
        });

        $('.sort').click(function() {
            $('.sort i').remove()
            let col = $(this).index();
            let dir = $(this).attr("dir");
            if (!dir) {
                $('#pairs tbody tr').sort((a, b) => {
                    return $(a).find('td').eq(col).text().localeCompare($(b).find('td').eq(col).text());
                }).appendTo('#pairs tbody');
                $(this).attr("dir", 1);
                $(this).append(`<i class='bi bi-arrow-down'></i>`);
            }
            else if (dir == 1) {
                $('#pairs tbody tr').sort((a, b) => {
                    return -$(a).find('td').eq(col).text().localeCompare($(b).find('td').eq(col).text());
                }).appendTo('#pairs tbody');
                $(this).attr("dir", -1);
                $(this).append(`<i class='bi bi-arrow-up'></i>`);
            }
            else if (dir == -1) {
                $('#pairs tbody tr').sort((a, b) => {
                    return $(a).attr("pair") - $(b).attr("pair");
                }).appendTo('#pairs tbody');
                $(this).removeAttr("dir");
                $(this).find('i').remove();
            }
        });
    }
    let p5 = function() {
        setDropdowns("Proto-Germanic", "a", "Old Norse", "b");
    }

    for(let fn of [p1, p2, p3, p4]) {
        try {
            await fn();
        }
        catch(e) {
            console.log(e)
        }
    }

    $(".phones, .languages").click(async function() {
        $modal = $(".modal");
        $modal.modal('show');
        let table = $(this).text();
        $('.modal-title').text(table);
        table = table.toLowerCase();
        let entries = await $.getJSON(url, {mode: "list", table: table});
        entries = Object.entries(entries).map(function(entry) {
            return {id: entry[0], value: entry[1]};
        }).filter(function(entry) {
            return entry.value.trim() !== '';
        });
        entries = escapeHTML(JSON.stringify(entries));
        $('.modal-body').html(`<input name='tags' id='tags' value='${entries}' data-role="tagsinput" class="form-control">`);
        table = table.slice(0, table.length-1);
        let tagInput = document.querySelector('#tags');
        let tagify = new Tagify(tagInput, {hooks: {
            beforeRemoveTag: function(tags) {
                return new Promise(async function(resolve, reject) {
                    let headers = {mode: "remove", table: table, id: tags[0].data.id};
                    let response = await $.get(url, headers);
                    !response.includes(`Fatal error`) ? resolve() : reject()
                })
            }
        }});
        tagify.on('add', function(e) {
            $.get(url, {mode: "insert", table: table, value: e.detail.data.value}, function(data) {});
        }).on('edit:updated', function(e) {
            $.get(url, {mode: "update", table: table, id: e.detail.data.id, value: e.detail.data.value}, function(data) {});
        });
    });

    $(".transitions").click(async function() {
        $modal = $(".modal");
        $modal.modal('show');
        let table = $(this).text();
        $('.modal-title').text(table);
        table = table.toLowerCase();
        let entries = await $.getJSON(url, {mode: "list", table: table});
        entries = Object.entries(entries).map(function(entry) {
            entry = entry[1]
            return {
                id: entry.transition_id,
                ids: `${entry.source_lang_id},${entry.target_lang_id}`,
                value: `${entry.source_lang_name} → ${entry.target_lang_name}`
            }
        })
        entries = escapeHTML(JSON.stringify(entries));
        $('.modal-body').html(`<input name='tags' id='tags' value='${entries}' data-role="tagsinput" class="form-control">`);
        table = table.slice(0, table.length-1);
        let tagInput = document.querySelector('#tags');
        let tagify = new Tagify(tagInput);

    });

}
function escapeHTML(text) {  
    var replacements= {"<": "&lt;", ">": "&gt;", "&": "&amp;", "'": "&apos;", "\"": "&quot;"};                      
    return text.replace(/[<>&'"]/g, function(character) {  
        return replacements[character];  
    }); 
}
function setDropdowns(sourceLanguage, sourcePhone, targetLanguage, targetPhone) {
    $('[name=source_lang]').val(sourceLanguage);
    $('[name=source_phone]').val(sourcePhone);
    $('[name=target_lang]').val(targetLanguage);
    $('[name=target_phone]').val(targetPhone);
}
$(function() {
    loadTable();

    $("#export").click(function() {
        exportData();
    })
});
</script>
</head>
<body>
    <div id='wrapper'>
        <header>
            <h1>Diachron DB</h1>
            <button class="btn btn-primary phones">Phones</button>
            <button class="btn btn-primary languages">Languages</button>
            <button class="btn btn-primary transitions">Transitions</button>
            <button class="btn btn-secondary" id="export">Export Data</button>
        </header>
        <content>
        </content>
        <footer>
        </footer>
    </div>
    <div class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm" data-bs-dismiss="modal">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>