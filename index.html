<html>
<link>
<title>Diachron DB</title>
<meta charset='UTF-8'>
<link href='https://www.matthewmorrone.com/psi-fff.ico' rel='shortcut icon' type='image/x-icon'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-white.ico' id='psi-white'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-black.ico' id='psi-black'>
<style>
@charset 'UTF-8';
@import 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css';
@import 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css';
@import 'https://www.matthewmorrone.com/font-awesome.min.css';
@import 'index.css';
</style>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/@yaireo/tagify"></script>
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<script src='js/icon.js'></script>
<script src='js/jquery.js'></script>
<script src='js/utils.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.js"></script>
<script>
let url = `mysql.php`;

$.fn.selected = function() {
    return $(this).find("option:selected").text();
}
$.fn.byValue = function(text) {
    return $(this).find("option").filter(function() {
        return $(this).text() === text;
    });
}
$.fn.selectOption = function(text) {
    return $(this).byValue(text).prop('selected', true);
}

function jsonToSelect(options, id) {
    let result = `<select id='${id}'>`;
        result += `<option></option>`;
    options.forEach(function(option) {
        let [key, val] = option;
        result += `<option value='${key}'>${val}</option>`;
    });
    result += '</select>';
    return result;
}
function jsonToOptions(options, id) {
    let result = `<option></option>`;
    options.forEach(function(option) {
        let [key, val] = option;
        result += `<option value='${key}'>${val}</option>`;
    });
    return result;
}
function jsonToDataList(options, id) {
    let result = `<input type=text name=${id} list=${id} />`;
        result += `<datalist id='${id}'>`;
    options.forEach(function(option) {
        let [key, val] = option;
        result += `<option data-id='${key}'>${val}</option>`;
    });
    result += '</datalist>';
    return result;
}
function jsonToTableRow(data, id) {
    let result = `<tr ${id}='${data['id']}'>`;
    for (let key in data) {
        if (key === 'id') continue;
        result += `<td class=${key}>${data[key]}</td>`;
    }
    result += `</tr>`;
    return result;
}
function jsonToTable(data, id) {
    let result = ``;
    result += `<table class="table" id='${id}'>`;
    result += `<thead>`;
    result += `<tr>`;
    for (let key in data[0]) {
        if (key === 'id') continue;
        result += `<th class='sort'>${key.replace(/_/g, ' ').toTitleCase()}</th>`;
    }
    result += `</tr>`;
    result += `</thead>`;
    result += `<tbody>`;
    for (let  i = 0; i < data.length; i++) {
        result += `<tr ${id.slice(0, id.length-1)}='${data[i]['id']}'>`;
        for (let key in data[i]) {
            if (key === 'id') continue;
            result += `<td class=${key}>${data[i][key]}</td>`;
        }
        result += `</tr>`;
    }
    result += `</tbody>`;
    result += `</table>`;
    return result;
}
function download(filename, text) {
    let element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}
async function exportData(format) {
    if (!format) return false;
    let headers = {mode: 'dump', format: format};
    if (format === 'json') {
        let data = await $getJSON(url, headers);
        download("diachron.json", JSON.stringify(data));
    }
    if (format === 'sql') {
        let data = await $get(url, headers);
        download("diachron.sql", data);
    }
    if (format === 'csv') {
        let data = await $get(url, headers);
        data = data.trim();
        data = data.split("~~~~~~~");

        const zip = new JSZip();
        const folder = zip.folder("diachron");

        data.forEach(function(datum) {
            datum = datum.trim();
            datum = datum.split("\n");
            let filename = datum[0]+".csv";
            let contents = datum.slice(1).join("\n");
            if (!filename || !contents) return;
            folder.file(filename, contents);
        });

        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "diachron.zip");
        });
    }
}

function sortDropdown($sel) {
    let $options = $sel.find(`option:not(:first-child)`);
    $options.detach().sort(function(a, b) {
        let at = $(a).text();
        let bt = $(b).text();
        return (at > bt) ? 1: ((at < bt) ? -1 : 0);
    });
    $options.appendTo($sel);
}

function randomTransition() {
    let $options = $('.search .transition select').find('option');
    let $random = $options.eq(~~(Math.random() * $options.length));
    $random.prop('selected', true);
    $('.search .transition select').trigger("change");
}

function sortTables() {
    $('.sort').click(function() {
        let $table = $(this).parents("table");
        let on = $table.attr("id").slice(0, -1);
        $('.sort i').remove();
        let col = $(this).index();
        let dir = $(this).attr("dir");
        if (!dir) {
            $table.find('tbody tr').sort((a, b) => {
                return $(a).find('td').eq(col).text().localeCompare($(b).find('td').eq(col).text());
            }).appendTo($table.find('tbody'));
            $(this).attr("dir", 1);
            $(this).append(`<i class='bi bi-arrow-down'></i>`);
        }
        else if (dir == 1) {
            $table.find('tbody tr').sort((a, b) => {
                return -$(a).find('td').eq(col).text().localeCompare($(b).find('td').eq(col).text());
            }).appendTo($table.find('tbody'));
            $(this).attr("dir", -1);
            $(this).append(`<i class='bi bi-arrow-up'></i>`);
        }
        else if (dir == -1) {
            $table.find('tbody tr').sort((a, b) => {
                return $(a).attr(on) - $(b).attr(on);
            }).appendTo($table.find('tbody'));
            $(this).removeAttr("dir");
            $(this).find('i').remove();
        }
    });
}

async function loadPairs(transition) {
    if (!transition) transition = localStorage.getItem("transition");
    let headers = {
        mode: "list", 
        table: "pairs", 
        data: {
            transition: transition
        }
    };
    if ($(".search .source_segment select").val()) {
        headers.data.source_segment = $(".search .source_segment select").selected();
    }
    if ($(".search .target_segment select").val()) {
        headers.data.target_segment = $(".search .target_segment select").selected();
    }
    let $table = $("#pairs tbody");
    $table.empty();
    if (!headers.data.source_segment && !headers.data.target_segment && !headers.data.transition) return;
    
    let rows = await $getJSON(url, headers);
    if (!rows) return;
    console.log(rows.size()+" rows loaded")

    rows && rows.forEach(function(row) {
        let $tableRow = $(jsonToTableRow(row, "pair"));
        $table.append($tableRow);
    });
    $("#pairs tbody .source_segment, #pairs tbody .target_segment").each(function() {
        let link = `segment-graph.html?segment=${$(this).text().replace(" → ", ",")}`;
        $(this).html(`<a href='${link}' target='_blank'>${$(this).text()}</a>`);
    });
    $("#pairs tbody .transition").each(function() {
        let link = `transition-graph.html?transition=${$(this).text().replace(" → ", ",")}`;
        $(this).html(`<a href='${link}' target='_blank'>${$(this).text()}</a>`);
    });
}

async function loadData() {
    let headers = {mode: 'list', table: 'segments'};
    let segments = await $getJSON(url, headers);
    segments = segments.map(segment => {
        return [segment.id, segment.value];
    });
    $(".search .source_segment select").html(jsonToOptions(segments));
    $(".search .target_segment select").html(jsonToOptions(segments));

    headers = {mode: 'list', table: 'transitions'};
    let transitions = await $getJSON(url, headers);
    transitions = transitions.map(transition => {
        return [transition.id, transition.transition];
    });
    $(".search .transition select").html(jsonToOptions(transitions));

    let transition = localStorage.getItem("transition");
    $(".search select").on("change", async function() {
        let transition = $(".search .transition select").find("option:selected").text();
        localStorage.setItem("transition", transition);
        loadPairs(transition);
    });
    if (transition) {
        $(".search .transition select").selectOption(transition).trigger("change");
    }

    sortTables();
}
function modalFunctionality() {

    $("#transitionsModal").click(async function() {
        let modal = "#tagsInput";
        let $modal = $(modal);
        $modal.modal('show');
        let table = $(this).text();
        $(`${modal} .modal-title`).text(table);
        table = table.toLowerCase();
        let headers = {mode: "list", table: table};
        let entries = await $getJSON(url, headers);
        entries = entries.map(function(entry) {
            let [source, target] = entry.transition.split(" → ")
            return {
                id: entry.id,
                source_language: source,
                target_language: target,
                citation: entry.citation
            };
        });

        table = table.slice(0, table.length-1);

        let $transitionsTable = $(jsonToTable(entries, "transitions"));
        $transitionsTable.find("thead tr").each(function() {
            $(this).prepend(`<th></th>`);
        });
        $transitionsTable.find("tbody tr").each(function() {
            $(this).prepend(`<td class='view-td'><button class='view' transition='${$(this).attr("transition")}'></button></td>`);
        });
        $(`${modal} .modal-body`).html($transitionsTable);

        $(`${modal} .modal-body tbody`).each(function(elem, index) {
            let arr = $.makeArray($("tr", this).detach());
            arr.reverse();
            $(this).append(arr);
        });

        sortTables();

        $("#transitions tbody .source_language, #transitions tbody .target_language").each(function() {
            let link = `family-graph.html?language=${$(this).text()}`;
            $(this).html(`<a href='${link}' target='_blank'>${$(this).text()}</a>`);
        });

        $('#transitions tbody .view').click(async function(e) {
            let transitionId = $(this).attr("transition");
            let transition = $(`.search .transition select option[value='${transitionId}']`).text();
            $(".search .transition select").val(transitionId).trigger("change");
            $modal.modal('hide');
        });

        $modal.on('hide.bs.modal', function(e) {
            loadPairs();
        });

    });
}
function setDropdowns(sourceSegment, targetSegment, transition) {
    $('.search .source_segment select').val(sourceSegment);
    $('.search .target_segment select').val(targetSegment);
    $('.search .transition select').val(transition);
}
function showError(e) {
    console.error(e);

    let modal = "#error";
    let $modal = $(modal);
    $modal.modal('show');

    $(`${modal} .modal-title`).text(`Error Status ${e.status}`);
    $(`${modal} .modal-body`).html(e.responseText);
    $(`${modal} .modal-body`).find("br").remove();
}
async function $get(url, data) {
    let result = false;
    try {
        result = await $.get(url, data);
    }
    catch(e) {
        showError(e);
    }
    return result;
}
async function $getJSON(url, data) {
    let result = false;
    try {
        result = await $.getJSON(url, data);
    }
    catch(e) {
        showError(e);
    }
    return result;
}
$(function() {
    $.ajaxSetup({cache: false});

    loadData();
    modalFunctionality();

    $("[rel='import']").each(async function() {
        let url = $(this).attr("href");
        let result = await $get(url);
        $(this).replaceWith(result);
    });

    $("#about").click(function() {
        let modal = "#aboutModal";
        let $modal = $(modal);
        $modal.modal('show');
        let table = $(this).text();
        $(`${modal} .modal-title`).text(table);
    });

    $("#random").click(function() {
        randomTransition();
    });

    $("#export li button").click(function() {
        exportData($(this).val());
    });
});
</script>
</head>
<body>
<div id='wrapper'>
    <header>
        <h1>Diachron DB</h1>
        <button class="btn btn-primary" id="random">Random</button>
        <button class="btn btn-primary"><a href='edit.html'>Edit</a></button>
        <button class="btn btn-primary" id="transitionsModal">Transitions</button>
        <button class="btn btn-primary" id="about">About</button>
        <div class="btn-group" role="group" id="export">
            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Export Data</button>
            <ul class="dropdown-menu">
                <li><button class="dropdown-item" value='json'>JSON</button></li>
                <li><button class="dropdown-item" value='sql'>SQL</button></li>
                <li><button class="dropdown-item" value='csv'>CSV</button></li>
            </ul>
        </div>
        <div class="simple-keyboard"></div>
    </header>
    <content>
        <table class="table table-striped table-hover" id='pairs'>
            <thead>
                <tr class='title'>
                    <th class="source_segment sort">Source</th>
                    <th class="target_segment sort">Target</th>
                    <th class="transition sort">Transition</th>
                    <th class="environment sort">Environment</th>
                    <th class="notes sort">Notes</th>
                </tr>
                <tr class='search'>
                    <th class="source_segment"><select></select></th>
                    <th class="target_segment"><select></select></th>
                    <th class="transition"><select></select></th>
                    <th class="environment"></th>
                    <th class="notes"></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </content>
    <footer>
        <a href="https://github.com/matthewmorrone/diachron-db" title="GitHub" target="_blank"><i class="fa fa-github" id="gh"></i></a>
    </footer>
</div>
<link rel="import" href="modals/tags.html">
<link rel="import" href="modals/error.html">
<link rel="import" href="modals/about.html">
</body>
</html>