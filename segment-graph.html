<html>
<head>
<title>Segment Graph | Diachron DB</title>
<meta charset='UTF-8'>
<link href='https://www.matthewmorrone.com/psi-fff.ico' rel='shortcut icon' type='image/x-icon'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-white.ico' id='psi-white'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-black.ico' id='psi-black'>
<script src='https://matthewmorrone.com/icon.js'></script>
<script src='https://matthewmorrone.com/jquery.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.22.1/cytoscape.min.js"></script>
<script src="https://unpkg.com/layout-base/layout-base.js"></script>
<script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-avsdf/cytoscape-avsdf.js"></script>
<script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.5.0/cytoscape-dagre.js"></script>
<script src="https://unpkg.com/klayjs@0.4.1/klay.js"></script>
<script src="https://cytoscape.org/cytoscape.js-klay/cytoscape-klay.js"></script>
<script src="https://unpkg.com/layout-base/layout-base.js"></script>
<script src="https://unpkg.com/cose-base/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-layout-utilities/cytoscape-layout-utilities.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-fcose/cytoscape-fcose.js"></script>
<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cose-bilkent/1.6.5/cytoscape-cose-bilkent.js"></script>
<script src="https://unpkg.com/webcola/WebCola/cola.js"></script>
<script src="https://cytoscape.org/cytoscape.js-cola/cytoscape-cola.js"></script>
<script src="https://unpkg.com/layout-base@1.0.2/layout-base.js"></script>
<script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
<script src="https://unpkg.com/cose-base@1.0.3/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-graphml/cytoscape-graphml.js"></script>
<script src="https://raw.githack.com/iVis-at-Bilkent/cytoscape.js-layvo/unstable/cytoscape-layvo.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-cise/cytoscape-cise.js"></script>
<script src="https://unpkg.com/weaverjs@1.2.0/dist/weaver.min.js"></script>
<script src="https://cytoscape.org/cytoscape.js-spread/cytoscape-spread.js"></script>
<script src="https://cytoscape.org/cytoscape.js-euler/cytoscape-euler.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-cosep/demo/forTestingCose/cytoscape-cosep-port.js"></script>
<script src="https://ivis-at-bilkent.github.io/cytoscape.js-cosep/cytoscape-cosep.js"></script>
<script src='js/utils.js'></script>
<script src='index.js'></script>
<script type="module">
let url = 'mysql.php';
function populateSelect(id, options) {
    let $select = $(`#${id}`)
    options.forEach(function(entry) {
        let [key, val] = entry;
        $select.append(`<option>${val}</option>`);
    });
}
function get() {
    let qs = document.location.search;
    qs = qs.split('+').join(' ');
    let params = {}, tokens, re = /[?&]?([^=]+)=([^&]*)/g;
    while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
    }
    return params;
}
async function loadSegments() {
    let headers = {mode: 'list', table: 'segments'};
    let segments = await $getJSON(url, headers);
    segments = segments.map(segment => {
        return [segment.id, segment.value];
    });
    populateSelect(`segments`, segments);
    let segment = get()?.segment;
    if (segment) $("#segments").val(segment)
}
async function loadSegmentData(segment) {
    segment = segment || $("#segments").val();
    let headers = {mode: 'graph', type: 'segment', data: {value: segment}};
    console.log(headers)
    let data = await $getJSON(url, headers);
    console.log(data)
    return data;
}
function cytoscapeFunctionality(cy) {
    cy.on('click', 'node', async function() {
        let segment = this.id();
        console.log(segment)
        $("#segments").val(segment).trigger("change");
    });
}
async function doStuff() {
    await loadSegments();
    let segment = $("#segments").val();
    let segmentData = await loadSegmentData(segment);
    console.log(segmentData)
    console.log(`layout: ${$("#layout").val()}`)
    let data = {
        container: document.getElementById('cy'),
        elements: segmentData,
        selectionType: 'single',
        wheelSensitivity: 0.2,
        layout: {
            name: $("#layout").val(),
            animate: true,
            nodeDimensionsIncludeLabels: true,
            fit: true,
            padding: 5,
        },
        style: [{
            selector: 'node',
            style: {
                'label': 'data(id)',
                "text-valign" : "center",
                "text-halign" : "center"
            }
        }, {
            selector: 'edge',
            style: {
                'label': 'data(transition)',
                "text-rotation": "autorotate",
            }
        },{
            selector: 'edge',
            style: {
                'width': 1,
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier',
            }
        }],
    };
    let cy = cytoscape(data);
    cytoscapeFunctionality(cy)
    $("#segments").change(async function() {
        segment = $("#segments").val();
        segmentData = await loadSegmentData(segment);
        data.elements = segmentData;
        data.layout.name = $("#layout").val();
        cy = cytoscape(data);
        cytoscapeFunctionality(cy);
        window.history.pushState("", "", "segment-graph.html?segment="+segment);
    });
    $("#edge").change(function() {
        console.log($(this).val())
        cy.style().selector('edge').style({
            'curve-style': $(this).val()
        }).update();
    });
    $("#layout").change(function() {
        let layoutName = $(this).val();
        console.log(`layout: ${$("#layout").val()}`)
        if (layoutName === "avsdf") {
            let layout = cy.layout({
                name: layoutName,
                nodeDimensionsIncludeLabels: true,
                fit: true,
                padding: 20,
            });
            layout.run();  
            return;   
        }
        let layout = cy.layout({
            name: layoutName,
            avoidOverlap: true,
            animate: true,
            nodeDimensionsIncludeLabels: true,
            fit: true,
            padding: 20,
        });
        layout.run();
    });
    $("#layout").val($("#layout").val()).trigger("change");
}
$(function() {
    doStuff();
});
</script>
<style>
*::-webkit-scrollbar { 
    display: none;
}
#cy {
    width: 100%;
    height: 100%;
    display: block;
    margin: auto;
}
</style>
</head>
<body>
<select id="segments"></select>
<select id="edge">
    <option>bezier</option>
    <option>unbundled-bezier</option>
    <option>unbundled-bezier(multiple)</option>
    <option>straight</option>
    <option>haystack</option>
    <option>segments</option>
    <option>taxi</option>
    <option>loop</option>
    <option>straight-triangle</option>
</select>
<select id="layout">
    <option>random</option>
    <optgroup label="Geometric">
        <option>grid</option>
        <option selected>circle</option>
        <option>concentric</option>
        <option>avsdf</option>
    </optgroup>
    <optgroup label="Hierarchical">
        <option>dagre</option>
        <option>breadthfirst</option>
        <option>klay</option>
    </optgroup>
    <optgroup label="Force-directed">
        <option>fcose</option>
        <option>cose-bilkent</option>
        <option>cose</option>
        <option>cosep</option>
        <option>cola</option>
        <option>euler</option>
        <option>spread</option>
    </optgroup>
</select>
<div id='cy'></div>
</body>
</html>