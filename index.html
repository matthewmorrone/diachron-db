<html>
<head>
<title>Diachron DB</title>
<meta charset='UTF-8'>
<link href='https://www.matthewmorrone.com/psi-fff.ico' rel='shortcut icon' type='image/x-icon'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-white.ico' id='psi-white'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-black.ico' id='psi-black'>
<style>
@charset 'UTF-8';
@import 'https://www.matthewmorrone.com/jquery.ui.css';
@import 'https://www.matthewmorrone.com/font-awesome.min.css';
@import 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css';
@import 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css';
@import 'https://unpkg.com/@yaireo/tagify/dist/tagify.css';
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/@yaireo/tagify"></script>
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<script src='https://matthewmorrone.com/icon.js'></script>
<script src='https://matthewmorrone.com/prefixfree.js'></script>
<script src='https://matthewmorrone.com/jquery.js'></script>
<script src='https://matthewmorrone.com/jquery.ui.js'></script>
<script src='https://matthewmorrone.com/jquery.helpers.js'></script>
<script src='utils.js'></script>
<script>
let url = `mysql.php`;

function jsonToDataList(options, id) {
    let result = `<input type=text name=${id} list=${id} />`;
    result += `<datalist id='${id}'>`;
    Object.entries(options).forEach(function(entry) {
        let [key, val] = entry;
        result += `<option data-id='${key}'>${val}</option>`;
    });
    result += '</datalist>';
    return result;
}
function jsonToTable(data, id) {
    let result = ``;
    result += `<table class="table" id='${id}'>`;
    result += `<thead>`;
    result += `<tr>`;
    for(key in data[0]) {
        if(key === 'id') continue;
        result += `<th class='sort'>${key.replace(/_/g, ' ').toTitleCase()}</th>`;
    }
    result += `<th></th>`;
    result += `</tr>`;
    result += `</thead>`;
    result += `<tbody>`;
    for(var i = 0; i < data.length; i++) {
        result += `<tr pair='${data[i]['id']}'>`;
        for(key in data[i]) {
            if(key === 'id') continue;
            result += `<td class=${key}>${data[i][key]}</td>`;
        }
        result += `<td><button class='ex' data-bs-id="${data[i]['id']}"></button></td>`;
        result += `</tr>`;
    }
    result += `</tbody>`;
    result += `</table>`;
    return result;
}
function submitPair() {
    let transition = $('#pairs [name=transition]').val();

    let submit = {
        mode: 'insert',
        table: 'pair',
        debug: true,
        data: {
            source_segment: $('#pairs [name=source_segment]').val(),
            target_segment: $('#pairs [name=target_segment]').val(),
            transition: $(`#pairs #transition option:contains("${transition}")`).attr('data-id'),
        }
    };
    if(!submit.data.source_segment
    || !submit.data.target_segment
    || !submit.data.transition
    ) {
        return;
    }
    $.get(url, submit, function(data) {
        loadTable();
    }).fail(function(e) {
        showError(e);
    });
}
function submitTransition() {
    let submit = {
        mode: 'insert',
        table: 'transition',
        data: {
            source_language: $('#transitions [name=transition_source_language]').val(),
            target_language: $('#transitions [name=transition_target_language]').val(),
            // citation: $('#citation_span textarea').val(),
            // notes: $('#notes_span textarea').val(),
        }
    };
    if(!submit.data.source_language
    || !submit.data.target_language
     ) {
        return;
    }
    $.get(url, submit, function(data) {
        $("#transitions").click()
    }).fail(function(e) {
        showError(e);
    });
}
function download(filename, text) {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);

    element.style.display = 'none';
    document.body.appendChild(element);

    element.click();

    document.body.removeChild(element);
}
async function exportData() {
    let data = await $getJSON(url, {mode: 'dump'});
    download("diachron.json", JSON.stringify(data));
}
function showError(e) {
    console.error(e)

    let modal = "#error";
    let $modal = $(modal);
    $modal.modal('show');

    $(`${modal} .modal-title`).text(`Error Status ${e.status}`);
    $(`${modal} .modal-body`).html(e.responseText);
    $(`${modal} .modal-body`).find("br").remove()
}
async function loadTable() {

    let pairs = await $getJSON(url, {mode: 'list', table: 'pairs'})
    $(`content`).html(`${jsonToTable(pairs, 'pairs')}`);
    $('#pairs thead').append(`<tr>
        <th><span id='source_segment_span'></span></th>
        <th><span id='target_segment_span'></span></th>
        <th><span id='source_language_span'></span></th>
        <th><span id='target_language_span'></span></th>
        <th><button class='plus'></button></th>
    </tr>`);

    let segments = await $getJSON(url, {mode: 'list', table: 'segments'});
    $('#source_segment_span').html(jsonToDataList(segments, 'source_segment'));
    $('#target_segment_span').html(jsonToDataList(segments, 'target_segment'));

    let languages = await $getJSON(url, {mode: 'list', table: 'languages'});
    $('#source_language_span').html(jsonToDataList(languages, 'source_language'));
    $('#target_language_span').html(jsonToDataList(languages, 'target_language'));
    
    $('#pairs thead tr').each(function() {
        $(this).find("th").eq($(this).find("th").length-2).after(`<th class='transition'>Transition</th>`)
    })
    $('#pairs thead tr:eq(1) .transition').html(`<span id='transition_span'></span>`);

    let transitionData = await $getJSON(url, {mode: 'list', table: 'transitions'});
    let transitions = {};
    for(let i = 0; i < transitionData.length; i++) {
        let transition = transitionData[i];
        transitions[transition.id] = `${transition.source_language_name} → ${transition.target_language_name}`;
    }
    $('#transition_span').html(jsonToDataList(transitions, 'transition'));
    $("#pairs tr :nth-child(3)").hide()
    $("#pairs tr :nth-child(4)").hide()

    $('#pairs tbody tr').each(function() {
        let source = $(this).find(".source_language").text();
        let target = $(this).find(".target_language").text();
        $(this).find("td").eq($(this).find("td").length-2).after(`<td class='transition'>${source} → ${target}</td>`)
    })

    /*
    $('#pairs input').on('change keyup', function() {
        $('#pairs tbody tr').show();
        $('#pairs tbody tr').each(function() {
            $(this).find("td").slice(0, 4).each(function() {
                let col = $(this).index();
                let val = $("#pairs input").eq(col).val();
                if (val === '') return;
                let text = $(this).text();
                if (val && text.includes(val)) $(this).parent().fadeIn();
                else {
                    $(this).parent().fadeOut();
                }
            });
        });
    });
    */


    $('#pairs tbody td:not(.transition)').click(function() {
        let $td = $(this);
        let text = $td.text();
        let $input = $(`<input class='edit' value='${text}' />`);
        $td.html($input);
        $input.select();
        $input.click(function(e) {
            return false;
        });
        $input.blur(function() {
            let newText = $(this).val();
            if (text !== newText) {
                let $tr = $(this).parents("tr");
                let headers = {
                    mode: "update",
                    table: "pair"
                }
                headers.data = {
                    id: $tr.attr("pair"),
                    source_segment: $tr.find('.source_segment').text() || newText,
                    target_segment: $tr.find('.target_segment').text() || newText,
                    source_language: $tr.find('.source_language').text() || newText,
                    target_language: $tr.find('.target_language').text() || newText,
                };
                console.log(headers)
                $.get(url, headers, function(data) {
                    console.log(data)
                })
            }
            $td.text(newText)
        });
        $input.keydown(function(e) {
            if (e.which === 13) $input.blur();
        });
    });

    $('#pairs .plus').click(() => submitPair());
    $('#pairs thead input').keyup((e) => {
        if (e.which === 13) $('#pairs .plus').click();
    });

    $('#pairs .ex').click(function(e) {
        let button = $(e).target();
        let id = button.getAttribute('data-bs-id');
        $.get(url, {mode: "remove", table: "pair", id: id}, function(data) {
            console.log(data);
            loadTable();
        }).fail(function(e) {
            showError(e);
        });

        /*
        [source_segment, target_segment, source_language, target_language] = [
            $(`[pair=${id}]`).find('.source_segment').text(),
            $(`[pair=${id}]`).find('.target_segment').text(),
            $(`[pair=${id}]`).find('.source_language').text(),
            $(`[pair=${id}]`).find('.target_language').text(),
        ];
        */
    });

    $('.sort').click(function() {
        $('.sort i').remove();
        let col = $(this).index();
        let dir = $(this).attr("dir");
        if (!dir) {
            $('#pairs tbody tr').sort((a, b) => {
                return $(a).find('td').eq(col).text().localeCompare($(b).find('td').eq(col).text());
            }).appendTo('#pairs tbody');
            $(this).attr("dir", 1);
            $(this).append(`<i class='bi bi-arrow-down'></i>`);
        }
        else if (dir == 1) {
            $('#pairs tbody tr').sort((a, b) => {
                return -$(a).find('td').eq(col).text().localeCompare($(b).find('td').eq(col).text());
            }).appendTo('#pairs tbody');
            $(this).attr("dir", -1);
            $(this).append(`<i class='bi bi-arrow-up'></i>`);
        }
        else if (dir == -1) {
            $('#pairs tbody tr').sort((a, b) => {
                return $(a).attr("pair") - $(b).attr("pair");
            }).appendTo('#pairs tbody');
            $(this).removeAttr("dir");
            $(this).find('i').remove();
        }
    });
    // setDropdowns("a", "b", "Proto-Germanic → Old Norse");

    $("#segments, #languages").click(async function() {
        let modal = "#tagsInput";
        let $modal = $(modal);
        $modal.modal('show');
        let table = $(this).text();
        $(`${modal} .modal-title`).text(table);
        table = table.toLowerCase();
        let entries = await $getJSON(url, {mode: "list", table: table});
        entries = Object.entries(entries).map(function(entry) {
            return {id: entry[0], value: entry[1]};
        }).filter(function(entry) {
            return entry.value.trim() !== '';
        });
        entries = JSON.stringify(entries).escapeHTML();
        $(`${modal} .modal-body`).html(`<input name='tags' id='tags' value='${entries}' data-role="tagsinput" class="form-control">`);
        table = table.slice(0, table.length-1);
        let tagInput = document.querySelector('#tags');
        let tagify = new Tagify(tagInput, {hooks: {
            beforeRemoveTag: function(tags) {
                return new Promise(async function(resolve, reject) {
                    let headers = {mode: "remove", table: table, id: tags[0].data.id};
                    let response = await $.get(url, headers);
                    !response.includes(`Fatal error`) ? resolve() : reject()
                })
            }
        }});
        tagify.on('add', function(e) {
            $.get(url, {mode: "insert", table: table, value: e.detail.data.value}, function(data) {}).fail(function(e) {
                showError(e);
            });
        }).on('edit:updated', function(e) {
            $.get(url, {mode: "update", table: table, id: e.detail.data.id, value: e.detail.data.value}, function(data) {}).fail(function(e) {
                showError(e);
            });
        });
    });

    $("#transitions").click(async function() {
        let modal = "#tagsInput";
        let $modal = $(modal);
        $modal.modal('show');
        let table = $(this).text();
        $(`${modal} .modal-title`).text(table);
        table = table.toLowerCase();
        let entries = await $getJSON(url, {mode: "list", table: table});
        entries = Object.values(entries).map(function(entry) {
            return {
                id: entry.id,
                source: entry.source_language_name,
                target: entry.target_language_name,
                // citation: entry.citation,
                // notes: entry.notes
            };
        });
        table = table.slice(0, table.length-1);

        $(`${modal} .modal-body`).html(`${jsonToTable(entries, "transitions")}`);
        $('#transitions thead').append(`<tr>
            <th><span id='transition_source_language_span'></span></th>
            <th><span id='transition_target_language_span'></span></th>
            <!--
            <th><span id='citation_span'></span></th>
            <th><span id='notes_span'></span></th>
            -->
            <th><button class='plus'></button></th>
        </tr>`);

        let languages = await $getJSON(url, {mode: 'list', table: 'languages'});
        $('#transition_source_language_span').html(jsonToDataList(languages, 'transition_source_language'));
        $('#transition_target_language_span').html(jsonToDataList(languages, 'transition_target_language'));
        $('#citation_span').html(`<textarea rows=1></textarea>`);
        $('#notes_span').html(`<textarea rows=1></textarea>`);
        $("textarea").each(function() {
            $(this).css("min-width", $(this).width());
        });

        $('#transitions .plus').click(() => {
            submitTransition();
        });

        $('#transitions .ex').click(function(e) {
            let button = $(e).target();
            let id = button.getAttribute('data-bs-id');
            let headers = {mode: "remove", table: "transition", id: id};
            $.get(url, headers, function(data) {
                $("#transitions").click();
            }).fail(function(e) {
                showError(e);
            });
        });
    });
}
async function $getJSON(url, data) {
    let result = -1;
    try {
        result = await $.getJSON(url, data);
    }
    catch(e) {
        showError(e);
    }
    return result;
}
function setDropdowns(sourceSegment, targetSegment, transition) {
    $('[name=source_segment]').val(sourceSegment);
    $('[name=target_segment]').val(targetSegment);
    $('[name=transition]').val(transition);
}
$(function() {
    loadTable();

    $("#export").click(function() {
        exportData();
    })
});
</script>
</head>
<body>
    <div id='wrapper'>
        <header>
            <h1>Diachron DB</h1>
            <button class="btn btn-primary" id="segments">Segments</button>
            <button class="btn btn-primary" id="languages">Languages</button>
            <button class="btn btn-primary" id="transitions">Transitions</button>
            <button class="btn btn-secondary" id="export">Export Data</button>
        </header>
        <content>
        </content>
        <footer>
        </footer>
    </div>
    <div class="modal fade" id="tagsInput" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm" data-bs-dismiss="modal">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="error" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content alert alert-block alert-danger">
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-block alert-danger"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="confirm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <style>
    @import 'style.css';
    content {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .alert {
        margin-bottom: 0px !important;
    }
    .modal-dialog {
        position: relative;
        display: table;
        overflow-y: auto;    
        overflow-x: auto;
        width: auto;
        min-width: 300px;  
    }
    .modal-dialog td {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        max-width: 200px;
    }
    textarea {
        resize: both;
        min-width: 200px;
        min-height: 26px;
    }
    input:focus, textarea:focus {
        outline: none;
    } 
    .transition input {
        float: left;
    }
    .edit {
        outline: none;
        border: 0px;
        width: 100%;
        height: 100%;
        padding: 0px;
        margin: 0px;
    }
    </style>
</body>
</html>