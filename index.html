<html>
<head>
<title>Diachron DB</title>
<meta charset='UTF-8'>
<link href='https://www.matthewmorrone.com/psi-fff.ico' rel='shortcut icon' type='image/x-icon'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-white.ico' id='psi-white'>
<link rel='shortcut icon' href='https://www.matthewmorrone.com/psi-black.ico' id='psi-black'>
<style>
@charset 'UTF-8';
@import 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css';
@import 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css';
@import 'https://unpkg.com/@yaireo/tagify/dist/tagify.css';
@import 'https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css';
@import 'style.css';
#pairs {
    width: 70%;
    margin: auto
}
#pairs thead input,
#pairs thead select {
    display: block;
    width: 100%;
    height: 26px;
    float: left;
}
#pairs th, #pairs td {
    max-width: 300px;
}
.source_segment, .target_segment {
    width: 200px;
}
.environment, .notes {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
.edit {
    outline: none;
    border: 1px solid black;
    width: 100%;
    height: 100%;
    padding: 0px;
    margin: -1px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/@yaireo/tagify"></script>
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<script src='https://matthewmorrone.com/icon.js'></script>
<script src='https://matthewmorrone.com/jquery.js'></script>
<script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.modern.js"></script>

<script src='utils.js'></script>
<script src='keyboard.js'></script>
<script>
let url = `mysql.php`;

function jsonToSelect(options, id) {
    let result = `<select id='${id}'>`;
        result += `<option></option>`
    Object.entries(options).forEach(function(entry) {
        let [key, val] = entry;
        result += `<option value='${key}'>${val}</option>`;
    });
    result += '</select>';
    return result;
}
function jsonToDataList(options, id) {
    let result = `<input type=text name=${id} list=${id} />`;
    result += `<datalist id='${id}'>`;
    Object.entries(options).forEach(function(entry) {
        let [key, val] = entry;
        result += `<option data-id='${key}'>${val}</option>`;
    });
    result += '</datalist>';
    return result;
}
function jsonToTableRow(data, id) {
    let result = ``;
    result += `<tr ${id}='${data['id']}'>`;
    for(key in data) {
        if(key === 'id') continue;
        result += `<td class=${key}>${data[key]}</td>`;
    }
    result += `<td class='ex-td'><button class='ex' data-bs-id="${data['id']}"></button></td>`;
    result += `</tr>`;
    return result;
}
function jsonToTable(data, id) {
    let result = ``;
    result += `<table class="table" id='${id}'>`;
    result += `<thead>`;
    result += `<tr>`;
    for(key in data[0]) {
        if(key === 'id') continue;
        result += `<th class='sort'>${key.replace(/_/g, ' ').toTitleCase()}</th>`;
    }
    result += `<th></th>`;
    result += `</tr>`;
    result += `</thead>`;
    result += `<tbody>`;
    for(var i = 0; i < data.length; i++) {
        result += `<tr ${id.slice(0, id.length-1)}='${data[i]['id']}'>`;
        for(key in data[i]) {
            if(key === 'id') continue;
            result += `<td class=${key}>${data[i][key]}</td>`;
        }
        result += `<td class='ex-td'><button class='ex' data-bs-id="${data[i]['id']}"></button></td>`;
        result += `</tr>`;
    }
    result += `</tbody>`;
    result += `</table>`;
    return result;
}
async function submitPair() {
    let transition = $(`#transition`).val();
    if (transition.includes(",")) transition = transition.split(",");
    else if (transition.includes(" → ")) transition = transition.split(" → ");
    else return;
    let [source_language, target_language] = transition;

    let submit = {
        mode: 'insert',
        table: 'pair',
        debug: true,
        data: {
            source_segment: $('#source_segment').val(),
            target_segment: $('#target_segment').val(),
            source_language: source_language,
            target_language: target_language,
            environment: $('#environment').val(),
            notes: $('#notes').val(),
        }
    };
    console.log(submit)
    if(!submit.data.source_segment
    || !submit.data.target_segment
    || !submit.data.source_language
    || !submit.data.target_language
    ) {
        return;
    }
    let result = await $get(url, submit);
    console.log(result);
    if (result) {
        await loadTable();
        $(`#transition`).val(transition);
    }
}
async function submitTransition() {
    let submit = {
        mode: 'insert',
        table: 'transition',
        debug: true,
        data: {
            source_language: $('#transition_source_language').val(),
            target_language: $('#transition_target_language').val(),
            citation: $('#transition_citation').val(),
        }
    };
    console.log(submit)
    if(!submit.data.source_language || !submit.data.target_language) return;

    let result = await $get(url, submit);
    console.log(result);
    if (result) $("#transitions").click()
}
function download(filename, text) {
    let element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}
async function exportData() {
    let data = await $getJSON(url, {mode: 'dump'});
    download("diachron.json", JSON.stringify(data));
}
function inputSelect(id, data) {
    $(`#${id}_span select`).remove();
    let $input = $(`#${id}`);
    let $select = $(jsonToSelect(data, `${id}Select`));
    $(`#${id}_span`).append($select);

    $select.change(function() {
        $input.val($select.find(":selected").text());
        // $input.attr("select", $(this).val());
        // $select.val("");
        // $input.focus();
    })
}

function randomTransition() {
    if (!$("transition").val()) {
        let $options = $('#transitionSelect').find('option');
        let $random = $options.eq(~~(Math.random() * $options.length));
        $random.prop('selected', true);
        $('#transitionSelect').trigger("change");
    }
}

async function loadTable() {
    console.log("load table")
    let pairs = await $getJSON(url, {mode: 'list', table: 'pairs'});

    let segments = await $getJSON(url, {mode: 'list', table: 'segments'});
    inputSelect("source_segment", segments);
    inputSelect("target_segment", segments);

    let transitions = await $getJSON(url, {mode: 'list', table: 'transitions'});
    transitions = transitions.map(transition => {
        return transition[0];
    });
    inputSelect("transition", transitions);
    
    $("#transitionSelect").on("change", async function(e) {
        e.preventDefault();
        let transition = $("#transitionSelect").val();
        localStorage.setItem("transition", transition);

        let headers = {mode: "list", table: "pairs", "transition": transition};
        let rows = await $getJSON(url, headers);
        let $table = $("#pairs tbody");
        $table.empty();
        rows.forEach(function(row) {
            $table.append(jsonToTableRow(row, "pair"));
        });
        
        $('#pairs tbody td:not(.ex-td)').off("click")
        $('#pairs tbody td:not(.ex-td)').dblclick(function() {
            let $td = $(this);
            let text = $td.text();
            let $input = $(`<input class='edit' value='${text}' />`);
            $input.width($td.width());
            $td.html($input);
            $input.select();
            $input.dblclick(function(e) {
                return false;
            })
            $input.blur(async function() {
                let newText = $(this).val();
                let $tr = $(this).parents("tr");
                $td.text(newText);
                if (text !== newText) {
                    let headers = {
                        mode: "update",
                        table: "pair"
                    }
                    let transition = $tr.find('.transition').text();
                    if (transition.includes(",")) transition = transition.split(",");
                    else if (transition.includes(" → ")) transition = transition.split(" → ");
                    else return;

                    let [source_language, target_language] = transition;

                    headers.data = {
                        id: $tr.attr("pair"),
                        source_segment: $tr.find('.source_segment').text(),
                        target_segment: $tr.find('.target_segment').text(),
                        source_language: source_language,
                        target_language: target_language,
                        environment: $tr.find('.environment').text(),
                        notes: $tr.find('.notes').text(),
                    };

                    console.log(headers.data);
                    let result = await $get(url, headers);
                    console.log(result);
                    if (result) loadTable();
                }
            });
            $input.keydown(function(e) {
                if (e.which === 13) $input.blur();
            });
        });

        $('#pairs .plus').click(() => submitPair());
        $('#pairs thead input').keyup((e) => {
            if (e.which === 13) $('#pairs .plus').click();
        });

        $('#pairs .ex').click(async function(e) {

            // doing this here since it doesn't have to wait for result
            $(this).parents("tr").remove();

            let button = e.target;
            let id = button.getAttribute('data-bs-id');

            let headers = {debug: true, mode: "remove", table: "pair", id: id};
            console.log(headers)

            let result = await $get(url, headers);
            console.log(result);
            // if (result) $(this).parents("tr").remove();
            // if (result) loadTable();
        });
    });

    if (localStorage.getItem("transition")) {
        $("#transitionSelect").val(localStorage.getItem("transition")).trigger("change")
    }

    $("#pairs input").on("focus", function(e) {
        $selectedInput = $(this);
        keyboard.setOptions({
            inputName: $(e)[0].target.id
        });
    });

    $('.sort').click(function() {
        $('.sort i').remove();
        let col = $(this).index();
        let dir = $(this).attr("dir");
        if (!dir) {
            $('#pairs tbody tr').sort((a, b) => {
                return $(a).find('td').eq(col).text().localeCompare($(b).find('td').eq(col).text());
            }).appendTo('#pairs tbody');
            $(this).attr("dir", 1);
            $(this).append(`<i class='bi bi-arrow-down'></i>`);
        }
        else if (dir == 1) {
            $('#pairs tbody tr').sort((a, b) => {
                return -$(a).find('td').eq(col).text().localeCompare($(b).find('td').eq(col).text());
            }).appendTo('#pairs tbody');
            $(this).attr("dir", -1);
            $(this).append(`<i class='bi bi-arrow-up'></i>`);
        }
        else if (dir == -1) {
            $('#pairs tbody tr').sort((a, b) => {
                return $(a).attr("pair") - $(b).attr("pair");
            }).appendTo('#pairs tbody');
            $(this).removeAttr("dir");
            $(this).find('i').remove();
        }
    });
    // setDropdowns("pʰ", "f", "Ancient Greek,Modern Greek");

    $("#segmentsModal, #languagesModal").click(async function() {
        let modal = "#tagsInput";
        let $modal = $(modal);
        $modal.modal('show');
        let table = $(this).text();
        $(`${modal} .modal-title`).text(table);
        table = table.toLowerCase();
        let entries = await $getJSON(url, {mode: "list", table: table});
        entries = Object.entries(entries).map(function(entry) {
            return {id: entry[0], value: entry[1]};
        }).filter(function(entry) {
            return entry.value.trim() !== '';
        });
        entries = JSON.stringify(entries).escapeHTML();
        $(`${modal} .modal-body`).html(`<input name='tags' id='tags' value='${entries}' data-role="tagsinput" class="form-control">`);
        table = table.slice(0, table.length-1);
        let tagInput = document.querySelector('#tags');
        let tagify = new Tagify(tagInput, {hooks: {
            beforeRemoveTag: function(tags) {
                return new Promise(async function(resolve, reject) {
                    let headers = {mode: "remove", table: table, id: tags[0].data.id};
                    let response = await $get(url, headers);
                    !response.includes(`Fatal error`) ? resolve() : reject()
                })
            }
        }});
        tagify.on('add', async function(e) {
            await $get(url, {mode: "insert", table: table, value: e.detail.data.value});
        }).on('edit:updated', async function(e) {
            await $get(url, {mode: "update", table: table, id: e.detail.data.id, value: e.detail.data.value});
        });

        $modal.on('hide.bs.modal', function(e) {
            loadTable();
        });
    });

    $("#transitionsModal").click(async function() {
        let modal = "#tagsInput";
        let $modal = $(modal);
        $modal.modal('show');
        let table = $(this).text();
        $(`${modal} .modal-title`).text(table);
        table = table.toLowerCase();
        let entries = await $getJSON(url, {mode: "list", table: table});
        entries = Object.entries(entries).map(function(entry) {
            let [id, val] = entry;
            let [source, target] = val[0].split(" → ")
            let citation = val[1];
            return {
                id: id,
                source_language: source,
                target_language: target,
                citation: citation
            };
        });
        table = table.slice(0, table.length-1);

        $(`${modal} .modal-body`).html(`${jsonToTable(entries, "transitions")}`);
        $(`${modal} .modal-body tbody`).each(function(elem,index) {
            let arr = $.makeArray($("tr", this).detach());
            arr.reverse();
            $(this).append(arr);
        });

        $('#transitions thead').append(`<tr>
            <th><span id='transition_source_language_span'></span></th>
            <th><span id='transition_target_language_span'></span></th>
            <th><span id='transition_citation_span'></span></th>
            <th><button class='plus'></button></th>
        </tr>`);

        let languages = await $getJSON(url, {mode: 'list', table: 'languages'});

        $('#transition_source_language_span').html(`<input type="text" id='transition_source_language' />`);
        $('#transition_target_language_span').html(`<input type="text" id='transition_target_language' />`);
        $('#transition_citation_span').html(`<input type="text" id='transition_citation' />`);

        $('#transitions .plus').click(() => {
            submitTransition();
        });

        $('#transitions tbody td:not(.ex-td)').off("click")
        $('#transitions tbody td:not(.ex-td)').click(function() {
            let $td = $(this);
            let text = $td.text();
            let $input = $(`<input class='edit' value='${text}' />`);
            console.log($td, text, $input)
            $td.html($input);
            $input.select();
            $input.click(function(e) { return false; });
            $input.blur(async function() {
                let newText = $(this).val();
                let $tr = $(this).parents("tr");
                $td.text(newText);
                if (text !== newText) {
                    let headers = {
                        mode: "update",
                        table: "transition"
                    }
                    headers.data = {
                        id: $tr.attr("transition"),
                        source_language: $tr.find('.source_language').text() || newText,
                        target_language: $tr.find('.target_language').text() || newText,
                        citation: $tr.find('.citation').text() || newText,
                    };
                    let result = await $get(url, headers);
                    console.log(result);
                    if (result) loadTable();
                }
            });
            $input.keydown(function(e) { if (e.which === 13) $input.blur(); });
        });

        $('#transitions .ex').click(async function(e) {
            let button = e.target;
            let id = button.getAttribute('data-bs-id');
            let headers = {mode: "remove", table: "transition", id: id};
            let result = await $get(url, headers);
            console.log(result);
            if (result) $("#transitions").click();
        });

        $modal.on('hide.bs.modal', function(e) {
            loadTable();
        });

    });
}
function setDropdowns(sourceSegment, targetSegment, transition) {
    $('#source_segment').val(sourceSegment);
    $('#target_segment').val(targetSegment);
    $('#transition').val(transition);
}
function showError(e) {
    console.error(e);

    let modal = "#error";
    let $modal = $(modal);
    $modal.modal('show');

    $(`${modal} .modal-title`).text(`Error Status ${e.status}`);
    $(`${modal} .modal-body`).html(e.responseText);
    $(`${modal} .modal-body`).find("br").remove();
}
async function $get(url, data) {
    let result = false;
    try {
        result = await $.get(url, data);
    }
    catch(e) {
        showError(e);
    }
    return result;
}
async function $getJSON(url, data) {
    let result = false;
    try {
        result = await $.getJSON(url, data);
    }
    catch(e) {
        showError(e);
    }
    return result;
}
$(function() {
    $.ajaxSetup({cache: false});

    loadTable();
    
    $("[rel='import']").each(async function() {
        let url = $(this).attr("href");
        let result = await $get(url);
        $(this).replaceWith(result);
    });

    makeKeyboard();
    $("#keyboard").click(function() {
        $('.simple-keyboard').slideToggle();
    });

    $("#about").click(function() {
        let modal = "#aboutModal";
        let $modal = $(modal);
        $modal.modal('show');
        let table = $(this).text();
        $(`${modal} .modal-title`).text(table);
    });

    $("#random").click(function() {
        randomTransition();
    });

    $("#export").click(function() {
        exportData();
    });
});
</script>
</head>
<body>
<div id='wrapper'>
    <header>
        <h1>Diachron DB</h1>
        <button class="btn btn-primary" id="random">Random</button>
        <button class="btn btn-primary" id="keyboard">Keyboard</button>
        <button class="btn btn-primary" id="segmentsModal">Segments</button>
        <button class="btn btn-primary" id="languagesModal">Languages</button>
        <button class="btn btn-primary" id="transitionsModal">Transitions</button>
        <button class="btn btn-primary" id="about">About</button>
        <button class="btn btn-secondary" id="export">Export Data</button>
        <div class="simple-keyboard"></div>
    </header>
    <content>
        <table class="table" id='pairs'>
            <thead>
                <tr>
                    <th class="source_segment sort" scope="col">Source Segment</th>
                    <th class="target_segment sort" scope="col">Target Segment</th>
                    <th class="transition sort" scope="col">Transition</th>
                    <th class="environment sort" scope="col">Environment</th>
                    <th class="notes sort" scope="col">Notes</th>
                    <th scope="col"></th>
                </tr>
                <tr>
                    <th class='source_segment'><span id="source_segment_span"><input type="text" id="source_segment" autocomplete="off"></span></th>
                    <th class='target_segment'><span id="target_segment_span"><input type="text" id="target_segment" autocomplete="off"></span></th>
                    <th class='transition'><span id="transition_span"><input type="text" id="transition" autocomplete="off"></span></th>
                    <th class='environment' style="vertical-align: top;"><span id="environment_span"><input type="text" id="environment" autocomplete="off"></span></th>
                    <th class='notes' style="vertical-align: top;"><span id="notes_span"><input type="text" id="notes" autocomplete="off"></span></th>
                    <th class=''><button class="plus"></button></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </content>
    <footer>
    </footer>
</div>
<link rel="import" href="modals/tags.html">
<link rel="import" href="modals/error.html">
<link rel="import" href="modals/about.html">
</body>
</html>